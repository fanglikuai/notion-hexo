---
categories: 博客阅读
tags:
  - 缓存
sticky: ''
description: ''
permalink: ''
title: 读有赞---多级缓存方案
date: '2025-09-08 08:00:00'
cover: 'https://prod-files-secure.s3.us-west-2.amazonaws.com/143cad91-961b-48b0-82dc-78fbb6eb5abe/a8ffedee-d30f-43fa-adac-95aa5a47f5e4/111468278_p0.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466TAGJTY2W%2F20250918%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250918T230039Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEE8aCXVzLXdlc3QtMiJIMEYCIQDJhoKLWYG2ltvaIsrgoQt4bftJaIWWnaJkPd018bYB%2FgIhAOCQ%2FjQqONTY2d65x%2FI3c%2BA1kYWJO8hm%2BJB9D6lqsJI3KogECMj%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1IgwEb%2Fg%2Fk%2FAQX6Qg0T0q3AOcW5IdlGl%2F3fOOkqVeROG6xXmT3R5YJn4jdf95gvJhf3s0CLMTSM5x98bJ2UELQYp%2BtcGYb8mHjDC9F1zD5EN9l1pBfXrhx9hcFw5OX25OrpuBdwToe9YtaaWNBozAM32ZxwKpkpXMjHK42Gtq55YPyeTkML0q%2FPniRqCuK8XFfiUwIXqMPxn7uR7ia7kYhc0gzsUzChXcBAke7VF0MVlI5W55cFqRT0w1dWdY%2Bq%2FlzXj2HC2%2BU2DJ9%2FmzcB9auvD0HpyQko6E5Zu8ccb%2Bucayp5yz4kFH2EkTFRbUFSyVZlf7acfOeCXFGwDRFX6x5ztw6FbDD7mxRjY1GfhCjEqhaHfuScZ5dO86soOt5g0LGPBmaymcqzgbMETc2V03MfDzJQROf2nW0Vhycw7Y5OOdTVP8il%2Bf7mT%2B2zvhb5lD7QbN0nNdIBjtjmOd0nivXij2t%2Bvg87l%2Fl0lIXpPv2divK3S6kkDzZez9p1z6%2BtIGg6uRYwXRUhtCb8cE%2F4EKQ%2FkREqr6uWtx6zdGyNu6nbnjDOz9xqM5mTBEVBMX8tJ3eOx%2FO70J5oJSe%2B9PxJTy6nEVnSHz0RGZ%2BJUFj2OosYyFIgecvVph6gniyuswtJkVnZyHeT0sn%2FO91%2F84eDCgnLLGBjqkAWlxToYSnNJXO2oF8DTEy9aWcowillFYQ4eaxJTribWGwPSfG4nGLlxVigTaHOIg512aQezng0Z9GXRfslM%2FwnUHHsCRnp74DtTDj4sfwitW3UdlGB2pzfk3cETJnK2EuOVAHmeQk4hbQw70MispW0gQkF4hyA3Dw7AQBpDYOTueYo98F9bzJm0GQZi7xOi5WAUgdeuQCfLSnjE0YfsEsfOdrip%2F&X-Amz-Signature=5e17a13f953735df373c5acfd21fcc60325d3b52df044a1d9f4587f606d7bc4d&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject'
updated: '2025-09-15 09:56:00'
index_img: /images/354bcaca8d763bed7629da78df89dd4e.jpg
banner_img: /images/354bcaca8d763bed7629da78df89dd4e.jpg
---

多级缓存的痛点：

1. 热点探测：如何快速且准确的发现热点访问key
2. 数据一致性：前置在应用层的缓存，如何保障与分布式缓存系统的数据一致性
3. 效果验证：看本地缓存命中率
4. 透明接入：减少入侵性

# TMC解决方案


tmc：透明多级缓存

- 应用层热点探测
- 应用层本地缓存
- 应用层缓存命中统计

# 为什么需要多级缓存

- 活动时间、活动类型、活动商品之类的信息不可预期，导致 缓存热点访问 情况不可提前预知；
- 缓存热点访问 出现期间，应用层少数 *热点访问 key * 产生大量缓存访问请求：冲击分布式缓存系统，大量占据内网带宽，最终影响应用层系统稳定性；

为了应对以上问题，需要一个能够 自动发现热点 并 将热点缓存访问请求前置在应用层本地缓存 的解决方案，这就是 TMC 产生的原因。


# 整体分析


![1747813796129-a2ed4703-4b89-4148-a114-2ec592e86923.png](/images/07d0c1fbd4a7be638f34caa29fd51f11.png)


TMC 对原生jedis包的`JedisPool`和`Jedis`类做了改造，在JedisPool初始化过程中集成TMC“热点发现”+“本地缓存”功能`Hermes-SDK`包的初始化逻辑，使`Jedis`客户端与缓存服务端代理层交互时先与`Hermes-SDK`交互，从而完成 “热点探测”+“本地缓存”功能的透明接入。


![1747815832426-23deec97-b1b8-4e70-b498-26f25938e2dc.png](/images/4b01bfd1a0ca9ae4df4b7de5a9f6b8eb.png)


# 稳定性

- 数据上报异步化：Hermes-SDK 使用`rsyslog技术`对“ key 访问事件”进行异步化上报，不会阻塞业务；
- 通信模块线程隔离：Hermes-SDK 的 通信模块 使用独立线程池+有界队列，保证事件上报&监听的I/O操作与业务执行线程隔离，即使出现非预期性异常也不会影响基本业务功能；
- 缓存管控：Hermes-SDK 的 热点模块 对本地缓存大小上限进行了管控，使其占用内存不超过 64MB（LRU），杜绝 JVM 堆内存溢出的可能；

# 一致性


TMC 本地缓存一致性表现在以下方面：

- Hermes-SDK 的 热点模块 仅缓存 热点key 数据，绝大多数非热点 key 数据由 缓存集群 存储；
- 热点key 变更导致 value 失效时，Hermes-SDK 同步失效本地缓存，保证 **本地强一致；**
- 热点key 变更导致 value 失效时，Hermes-SDK 通过 etcd集群 广播事件，异步失效业务应用集群中其他节点的本地缓存，保证 **集群最终一致**；

# TMC热点发现


![1747818626432-bac9caf4-77f8-4764-88bd-bd421c312961.png](/images/91b414e5d974b3a8913936b2d6885554.png)

- 数据收集：收集 增强sdk上报的key访问事件
- 热度滑窗：时间轮
- 热度汇集：`<key,热度>`的形式来进行热度排序汇总
- 热点探测：topN的key进行推送

# 数据收集


**Hermes-SDK** 通过本地`rsyslog`将 _**key访问事件**_ 以协议格式放入 **kafka** ，**Hermes服务端集群** 的每个节点消费 kafka 消息，实时获取 _**key访问事件**_。


访问事件协议格式如下：

- appName：集群节点所属业务应用
- uniqueKey：业务应用 _key访问事件_ 的 key
- sendTime：业务应用 _key访问事件_ 的发生时间
- weight：业务应用 _key访问事件_ 的访问权值

**Hermes服务端集群** 节点将收集到的 _**key访问事件**_ 存储在本地内存中，内存数据结构为`Map<String, Map<String, LongAdder>>`，对应业务含义映射为`Map< appName , Map< uniqueKey , 热度 >>`。


# 热度滑窗


这一部分就是整了一个时间轮出来，然后每三秒执行一次，总共存储30秒的访问频率。


![1747818921464-e90d8ed9-9cbb-4bc9-9f9e-455705e303ba.png](/images/17b8cb750d14d4e2d85d59454004e2e2.png)


### 时间滑窗


**Hermes服务端集群** 节点，对每个App的每个 key ，维护了一个 _**时间轮**_：

- 时间轮中共10个 _**时间片**_，每个时间片记录当前 key 对应 3 秒时间周期的总访问次数；
- 时间轮10个时间片的记录累加即表示当前 key 从当前时间向前 30 秒时间窗口内的总访问次数；

### 映射任务


**Hermes服务端集群** 节点，对每个 App _每3秒_ 生成一个 **映射任务** ，交由节点内 _“缓存映射线程池”_ 执行。**映射任务** 内容如下：

- 对当前 App ，从`Map< appName , Map< uniqueKey , 热度 >>`中取出 _appName_ 对应的Map `Map< uniqueKey , 热度 >>`；
- 遍历`Map< uniqueKey , 热度 >>`中的 key ，对每个 key 取出其热度存入其 _**时间轮**_ 对应的时间片中；

# 热度汇聚


遍历整个时间轮，对每个key的三十秒的访问频率进行统计并排序


![1747818921480-0fce04e4-052d-43ed-aed8-9d9ade1f46dc.jpeg](/images/1d10ccc0431e7a77cde084f375f2f9c9.jpeg)


完成第二步“热度滑窗”后，**映射任务** 继续对当前 App 进行“热度汇聚”工作：

- 遍历 App 的 key ，将每个 key 的 **时间轮** 热度进行汇总（即30秒时间窗口内总热度）得到探测时刻 **滑窗总热度**；
- 将 `< key , 滑窗总热度 >` 以排序集合的方式存入 _Redis存储服务_ 中，即 **热度汇聚结果**；

**总体流程：**


![1747819071777-74c13fc7-a659-43fa-a329-95cfdb24c88f.png](/images/e1d648dd2dc592f43fd24f28f1d30fc1.png)


# 特性总结


### 实时性


**Hermes-SDK**基于rsyslog + kafka 实时上报 _**key访问事件**_。 **映射任务** 3秒一个周期完成“热度滑窗” + “热度汇聚”工作，当有 _**热点访问场景**_ 出现时最长3秒即可探测出对应 **热点key**。


### 准确性


key 的**热度汇聚结果**由“基于时间轮实现的滑动窗口”汇聚得到，相对准确地反应当前及最近正在发生访问分布。


### 扩展性


**Hermes服务端集群** 节点无状态，节点数可基于 kafka 的 partition 数量横向扩展。


“热度滑窗” + “热度汇聚” 过程基于 App 数量，在单节点内多线程扩展。

