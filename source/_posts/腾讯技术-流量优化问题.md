---
categories: 博客阅读
tags:
  - redis
  - mysql
sticky: ''
description: ''
permalink: ''
title: 腾讯技术-流量优化问题
date: '2025-09-14 17:39:00'
cover: 'https://prod-files-secure.s3.us-west-2.amazonaws.com/143cad91-961b-48b0-82dc-78fbb6eb5abe/0d7c8540-9c98-4451-9fd0-cddb216a6b25/wallhaven-ly9mqp.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4667HKUNUME%2F20250918%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250918T060040Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjED4aCXVzLXdlc3QtMiJHMEUCIQCbu3VtJJM6nqTK8xUSnz0N8LMAFYY3oXOHn2BNElIg%2FwIgNbiFuQ1z4%2FGMeSeA9WLGEASMA8hCMXPTSoWl%2F%2FXijQ0qiAQIt%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDLVXt9uSM5Uon2ZlrCrcAyp16EMvOc9D6zQhIM%2Fot4YTDk2MLxhGqUqb5BXnpxno3xAp5RbUaLMN4MyQDC9DxNKyFu4MjGAks0BWwa68uC%2B2IrLGVSHcEKkq9lbL%2FnKoXCKHTdEco99k1NgKE2hXGuTdRfmgC1OUowX1Irrym6%2BLi4nkFu%2FQSPLtcu4vpeM17%2BGEDGOPg%2FYoGff4v2oaCpsABEecoxr%2B%2FIqy91%2FfKT0YSMZG7De6USg%2B3dkiJePfVf9XRSVtdIWls0ueLxkGU3Ud%2FS7rKbS7Fiv6YrfYmLskAhM8PpkcKUE5kQiMXvBwjavli8YQefz1Zg2JwF1Olx2LLlkXSaEcCicEdqHzm8x42AG98OuwYi3xLp9d%2Fh01y4kg6dnO4jK0aSOzE5yn4ANMF8aF5XjlighaEYn3B4lYG%2B%2FhK0dGj8CFi%2B1jdT6evvHcKReBX9M8EUBR5xYTb9nUzwBnT0%2B9JS8u1d6SaIjncQesLEPFbdOnklvKVifHRc5ra7YOOSTl6qXQ3rWrCdsU2hGBje4CceAFESU0RYcTxnhiVP3%2F8SOVUAtb%2F3RL7HOVR3jUOvndgvaw2scj4ucJwGEOtUMFcUdCQMr%2BhuhplGqEFbyXZBVaQZXXre5GZ6%2Bo4q7l08RFNi%2FUMLe2rsYGOqUBTfAMQV1mtCYB6bG%2F5x3HBdcr2d5i2E1jxT30eIwg%2FHsimMUf7%2F9hUhGDemuOnQgEgPHmD3oWj5L%2Fzqkd8KkdqAz1KHMd55AXXY3nWddeJb9iSp7WqNyOIOdWQoOt4ccvm2n4tFBDesTBkHsjaxCzoEQb%2BrFxb0loNSxcNR4nq%2BvF%2FuTQAWMnPJsEz%2BpNTLXLvFBuA8pRbKL3EAdl0f4qGDtwAvD9&X-Amz-Signature=50ff48ffe10bfe8f0e868f2ed177b4491096f5f2e3b594f7c9a26245548050b0&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject'
updated: '2025-09-16 14:08:00'
index_img: /images/adddad97caca738a065ef73cd720e5d2.jpg
banner_img: /images/adddad97caca738a065ef73cd720e5d2.jpg
---

[亿级流量！3倍并发！10倍平均耗时减少！腾讯会议高性能录制列表查询系统设计实践](https://mp.weixin.qq.com/s/DQ6juZBexn3IY_ZaI1x0DQ)


# 深分页解决方案

1. 延迟join

```sql
SELECT * FROM t_records
INNER JOIN (
    SELECT id FROM t_records WHERE uid = '{my_uid}' LIMIT X, 30
) AS t2 USING (id);
```

> 就是直接分页的时候只扫描出id
1. seek method

```sql
SELECT id FROM t_records
WHERE uid = '{my_uid}' AND id > {last_id}
LIMIT 30;
```

> 记录上次的索引id，选择大于这个id的记录

**弊端：**

1. 无法支持跳页（一半不影响）
2. 如果要排序的话
    1. 例如创建时间：需要保证id越大的创建时间越大？
    2. 为什么不直接在内存排序？

# 缓存


一致性问题


首页结果缓存的缺点：

1. 一致性维护的困难。例如新增、删除视频的时候，固然需要维护这个 List 的一致性。你能想到可能是新增、删除的时候，直接对 list 进行遍历，找到对应的视频进行新增或者删除操作即可。但实际上在读、写并发场景下，动态维护缓存是很容易导致不一致的。如果为了更好的一致性考虑，可以考虑有变更的时候便删除掉整个 list 缓存。
2. 过于频繁的维护缓存。无论走修改策略还是删除策略，其维护的时机就是缓存的内容发生变动的时候。缓存整个结果意味着结果变动的内容可能性非常大。例如录制的状态是经常发生变更的：新建->录制中、转码中、转码完成、完成等等。录制的标题也是可能发生变动的，录制的打击状态也是随时可能变的，权限也是可能被管理员修改的。这些单一录制的任意字段都可能需要对整个 list 缓存进行维护（修改/删除），如果采取的是删除策略，那么频繁的维护动作会导致缓存经常失效而性能提升有限。如果采取更新策略则又维护困难且有一致性的问题。
3. 缓存扩散维护的困难。这个在“我的录制”里不存在这样的问题，但是假设我们把“我的录制”的功能范围扩充为：属于我的录制以及我看过的录制。这种情况下用首页结果缓存就会有巨大挑战。**因为一个视频 X 可能被 N 个人看到。但是每个人都有自己的首页缓存（一个人一条 list 的 redis 结构**

    ），当 X 的某个字段（例如标题）发生变动的时候，我们需要找到这 N 个人的 list 结构。你可能会说，可以采取 keys 的操作找出来这些 list 去维护即可。但是 keys 操作是 O(N) 时间复杂度的操作，性能极差。哪怕我们采取 scan 去替换 keys，在 N 极大的情况下，这里的损耗也是非常巨大的。


解决方案：没一个id都缓存成一个key，然后把id都从数据库查出来，一个一个去查询缓存


![images6f4a4221ce40ac0edf09eda944fbc011.webp](/images/0e36309ec62ecc97df01afd53fb5fb4d.webp)


第三种：把数据库查询到的id列表进行缓存起来，然后再根据id去查询每一个数据（两次与redis进行交互）


高效：

> 对于每一个数据，分开进行缓存
>
> ![images8f6ff72afb5a601c7492f112d61b9d1c.webp](/images/97319de15a803ece8bfc8f0e9ccb87f0.webp)
>
>

# 数据源问题


union all性能


跨库分页问题


如果内存聚合：**还有分页问题**


---


## 解决方案


空间换时间：再构建一个数据源，聚合多个数据源


数据拓展设计： 按照用户id进行分区

> 大V用户：一个用户特别多
>
> uid+文件 id 联合键进行分区
>
>

# 数据一致性问题

> 腾讯使用：可靠消息+离线对账混合处理

MQ问题：


mqtt协议

